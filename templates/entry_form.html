{% extends '_base.html' %}
{% block content %}
  <h1 class="text-2xl font-bold mb-4">{{ 'Edit entry' if entry else 'New entry' }}</h1>

  <form class="card space-y-4" method="post" enctype="multipart/form-data" id="entry-form">
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Date</label>
        <input type="date" name="when" value="{{ (entry.when if entry else today).isoformat() }}" class="w-full border rounded-xl px-3 py-2" required />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Weight (kg)</label>
        <input type="number" step="0.1" name="weight" value="{{ entry.weight if entry and entry.weight else '' }}" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Energy (1–5)</label>
        <input type="number" min="1" max="5" name="energy" value="{{ entry.energy if entry and entry.energy else '' }}" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Water (ml)</label>
        <input type="number" step="100" name="water_ml" value="{{ entry.water_ml if entry and entry.water_ml else '' }}" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Mood</label>
        <input type="text" name="mood" placeholder="great / ok / rough" value="{{ entry.mood if entry and entry.mood else '' }}" class="w-full border rounded-xl px-3 py-2" />
      </div>
      <div class="md:col-span-3">
        <label class="block text-sm font-semibold mb-1">Feelings / notes</label>
        <textarea name="feelings" rows="4" class="w-full border rounded-xl px-3 py-2" placeholder="Hunger level, focus, sleep, exercise...">{{ entry.feelings if entry and entry.feelings else '' }}</textarea>
      </div>
    </div>

    <div>
      <label class="block text-sm font-semibold mb-1">Photos</label>
      <input type="file" name="photos" accept="image/*" multiple class="block w-full text-sm" />
      {% if entry and entry.photos %}
        <div class="grid grid-cols-3 gap-2 mt-2">
          {% for p in entry.photos %}
            <div class="relative group">
              <img src="{{ url_for('uploaded_file', filename=p.filename) }}" class="w-full h-28 object-cover rounded-xl border" />
              <button
                type="button"
                class="btn btn-secondary text-xs absolute top-1 right-1 opacity-90"
                onclick="deletePhoto('{{ url_for('delete_photo', photo_id=p.id) }}', this)"
                title="Remove photo"
              >✕</button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="flex gap-2">
      <button class="btn btn-primary" type="submit">Save</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>

  <script>
    async function deletePhoto(url, btn) {
      if (!confirm('Remove photo?')) return;
      try {
        const resp = await fetch(url, { method: 'POST' });
        if (!resp.ok) throw new Error('Delete failed');
        const card = btn.closest('.relative');
        if (card) card.remove();
      } catch (e) {
        alert('Could not delete photo. Try again.');
      }
    }
  </script>
{% endblock %}